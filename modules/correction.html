<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Correction algorithms &mdash; pySC 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=988d0652" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=2389946f"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Lattice properties" href="lattice_properties.html" />
    <link rel="prev" title="Core structure" href="core_structure.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/pySC_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="core_functions.html">Core functions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="core_functions.html#beam">Beam</a></li>
<li class="toctree-l2"><a class="reference internal" href="core_functions.html#pySC.core.beam.all_elements_reading"><code class="docutils literal notranslate"><span class="pre">all_elements_reading()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="core_functions.html#pySC.core.beam.beam_transmission"><code class="docutils literal notranslate"><span class="pre">beam_transmission()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="core_functions.html#pySC.core.beam.bpm_reading"><code class="docutils literal notranslate"><span class="pre">bpm_reading()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="core_functions.html#pySC.core.beam.generate_bunches"><code class="docutils literal notranslate"><span class="pre">generate_bunches()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="core_functions.html#lattice-setting">Lattice setting</a></li>
<li class="toctree-l2"><a class="reference internal" href="core_functions.html#pySC.core.lattice_setting.switch_cavity_and_radiation"><code class="docutils literal notranslate"><span class="pre">switch_cavity_and_radiation()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="core_structure.html">Core structure</a><ul>
<li class="toctree-l2"><a class="reference internal" href="core_structure.html#simulated-commissioning">Simulated Commissioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="core_structure.html#pySC.core.simulated_commissioning.SimulatedCommissioning"><code class="docutils literal notranslate"><span class="pre">SimulatedCommissioning</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="core_structure.html#subclasses">Subclasses</a></li>
<li class="toctree-l2"><a class="reference internal" href="core_structure.html#pySC.core.classes.DotDict"><code class="docutils literal notranslate"><span class="pre">DotDict</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="core_structure.html#pySC.core.classes.Indices"><code class="docutils literal notranslate"><span class="pre">Indices</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="core_structure.html#pySC.core.classes.Injection"><code class="docutils literal notranslate"><span class="pre">Injection</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="core_structure.html#pySC.core.classes.Sigmas"><code class="docutils literal notranslate"><span class="pre">Sigmas</span></code></a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Correction algorithms</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#trajectory-and-orbit">Trajectory and Orbit</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pySC.correction.orbit_trajectory.balance"><code class="docutils literal notranslate"><span class="pre">balance()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#pySC.correction.orbit_trajectory.correct"><code class="docutils literal notranslate"><span class="pre">correct()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#pySC.correction.orbit_trajectory.first_turn"><code class="docutils literal notranslate"><span class="pre">first_turn()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#pySC.correction.orbit_trajectory.stitch"><code class="docutils literal notranslate"><span class="pre">stitch()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#rf">RF</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pySC.correction.rf.phase_and_energy_error"><code class="docutils literal notranslate"><span class="pre">phase_and_energy_error()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#tune">Tune</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pySC.correction.tune.tune_scan"><code class="docutils literal notranslate"><span class="pre">tune_scan()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#chromaticity">Chromaticity</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pySC.correction.chroma.fit_chroma"><code class="docutils literal notranslate"><span class="pre">fit_chroma()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="lattice_properties.html">Lattice properties</a><ul>
<li class="toctree-l2"><a class="reference internal" href="lattice_properties.html#pySC.lattice_properties.response_model.SCgetModelDispersion"><code class="docutils literal notranslate"><span class="pre">SCgetModelDispersion()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="lattice_properties.html#pySC.lattice_properties.response_model.SCgetModelRING"><code class="docutils literal notranslate"><span class="pre">SCgetModelRING()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="lattice_properties.html#pySC.lattice_properties.response_model.SCgetModelRM"><code class="docutils literal notranslate"><span class="pre">SCgetModelRM()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging</a><ul>
<li class="toctree-l2"><a class="reference internal" href="logging.html#pySC.utils.logging_tools.DebugMode"><code class="docutils literal notranslate"><span class="pre">DebugMode</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html#pySC.utils.logging_tools.MaxFilter"><code class="docutils literal notranslate"><span class="pre">MaxFilter</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html#pySC.utils.logging_tools.file_handler"><code class="docutils literal notranslate"><span class="pre">file_handler()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html#pySC.utils.logging_tools.get_logger"><code class="docutils literal notranslate"><span class="pre">get_logger()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="logging.html#pySC.utils.logging_tools.stream_handler"><code class="docutils literal notranslate"><span class="pre">stream_handler()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="utils.html">Utils</a><ul>
<li class="toctree-l2"><a class="reference internal" href="utils.html#at-wrapper">AT wrapper</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.html#pySC.utils.sc_tools.ords_from_regex"><code class="docutils literal notranslate"><span class="pre">ords_from_regex()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.html#pySC.utils.sc_tools.pinv"><code class="docutils literal notranslate"><span class="pre">pinv()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.html#pySC.utils.sc_tools.randnc"><code class="docutils literal notranslate"><span class="pre">randnc()</span></code></a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">pySC</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Correction algorithms</li>
      <li class="wy-breadcrumbs-aside">
              <!-- User defined GitHub URL -->
              <a href="https://github.com/lmalina/pySC" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="module-pySC.correction.orbit_trajectory">
<span id="correction-algorithms"></span><h1>Correction algorithms<a class="headerlink" href="#module-pySC.correction.orbit_trajectory" title="Permalink to this heading"></a></h1>
<section id="trajectory-and-orbit">
<h2>Trajectory and Orbit<a class="headerlink" href="#trajectory-and-orbit" title="Permalink to this heading"></a></h2>
<p>This module contains functions to correct trajectory (first turns(s)) and orbit.
In all functions, the provided response matrix needs to be matching:</p>
<blockquote>
<div><p>registered BPMs in SC.ORD.BPM or bpm_ords if provided
registered CMs in SC.ORD.CM or cm_ords if provided
assumes all BPMs are used both horizontal and vertical plane</p>
</div></blockquote>
</section>
<dl class="py function">
<dt class="sig sig-object py" id="pySC.correction.orbit_trajectory.balance">
<span class="sig-prename descclassname"><span class="pre">pySC.correction.orbit_trajectory.</span></span><span class="sig-name descname"><span class="pre">balance</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">SC</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">response_matrix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reference</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cm_ords</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bpm_ords</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">eps</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.0001</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">maxsteps</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">10</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">pinv_params</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/pySC/correction/orbit_trajectory.html#balance"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#pySC.correction.orbit_trajectory.balance" title="Permalink to this definition"></a></dt>
<dd><p>Balance two-turn BPM readings</p>
<p>Generates a period-1 closed orbit, after two-turn transmission has been
achieved. This is done by iteratively applying correction steps, calculated
based on the pseudo-inverse two-turn trajectory response matrix <cite>Mplus</cite>.  The
trajectory in the first turn is corrected towards the reference orbit <cite>reference</cite>,
whereas the trajectory in the second turn is corrected towards the trajectory
measured in the first turn; this approach seems to be more stable than the
directly application of the two-turn TRM to the two-turn BPM readings.
It converges to a state where BPM readings in both turns are very similar,
indicating a period-1 closed orbit.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>SC</strong> -- SimulatedCommissioning class instance.</p></li>
<li><p><strong>response_matrix</strong> -- Trajectory-response matrix.</p></li>
<li><p><strong>reference</strong> -- (None) target orbit in the format <cite>[x_1 … x_n y_1 …y_n]</cite>, where
[x_i,y_i]` is the target position at the i-th BPM.</p></li>
<li><p><strong>cm_ords</strong> -- List of CM ordinates to be used for correction (SC.ORD.CM)</p></li>
<li><p><strong>bpm_ords</strong> -- List of BPM ordinates at which the reading should be evaluated (SC.ORD.BPM)</p></li>
<li><p><strong>maxsteps</strong> -- break, if this number of correction steps have been performed (default = 100)</p></li>
<li><p><strong>eps</strong> -- break, if the coefficient of variation of the RMS BPM reading is below this value</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>SimulatedCommissioning class instance with corrected <cite>SC.RING</cite></p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="pySC.correction.orbit_trajectory.correct">
<span class="sig-prename descclassname"><span class="pre">pySC.correction.orbit_trajectory.</span></span><span class="sig-name descname"><span class="pre">correct</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">SC</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">response_matrix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reference</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cm_ords</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bpm_ords</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">eps</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.0001</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">maxsteps</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">30</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scaleDisp</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">pinv_params</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/pySC/correction/orbit_trajectory.html#correct"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#pySC.correction.orbit_trajectory.correct" title="Permalink to this definition"></a></dt>
<dd><p>Iterative orbit/trajectory correction</p>
<p>Iteratively applies orbit corrections using the pseudoinverse of the
trajectory <cite>response_matrix</cite>, until a break-condition specified by one
of ‘eps’, ‘target’ or ‘maxsteps’ is met.
The dispersion can be included, thus the rf frequency as a correction
parameter. If the dispersion is to be included, <cite>response_matrix</cite> has to have the size
<cite>(2 * len(SC.ORD.BPM)) x (len(SC.ORD.HCM) + len(SC.ORD.VCM) + 1)</cite>, otherwise the size
<cite>(2 * len(SC.ORD.BPM)) x (len(SC.ORD.HCM) + len(SC.ORD.VCM))</cite>, or correspondingly if the CM
and/or BPM ordinates for the correction is explicitly given (see options below). <cite>SC.RING</cite> is
assumed to be a lattice with transmission through all considered turns.
Raises RuntimeError if transmission is lost.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>SC</strong> -- SimulatedCommissioning class instance.</p></li>
<li><p><strong>response_matrix</strong> -- Trajectory/orbit-response matrix.</p></li>
<li><p><strong>reference</strong> -- (None) target orbit in the format <cite>[x_1 … x_n y_1 …y_n]</cite>, where
[x_i,y_i]` is the target position at the i-th BPM.</p></li>
<li><p><strong>cm_ords</strong> -- List of CM ordinates to be used for correction (SC.ORD.CM)</p></li>
<li><p><strong>bpm_ords</strong> -- List of BPM ordinates at which the reading should be evaluated (SC.ORD.BPM)</p></li>
<li><p><strong>maxsteps</strong> -- break, if this number of correction steps have been performed (default = 100)</p></li>
<li><p><strong>eps</strong> -- break, if the coefficient of variation of the RMS BPM reading is below this value</p></li>
<li><p><strong>target</strong> -- (default =0 ) break, if the RMS BPM reading reaches this value</p></li>
<li><p><strong>scaleDisp</strong> -- (default =0 ) Scaling factor for and flag indicating if the dispersion is included in the response matrix</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>SimulatedCommissioning class instance with corrected <cite>SC.RING</cite></p>
</dd>
</dl>
<p class="rubric">Examples</p>
<p>Switch to orbit mode, get the model response matrix and dispersion. Calculate the psudo-inverse
while scaling the dispersion by 1E7 and using a Tikhonov regularization parameter of 10.
Finally, apply  and apply orbit feedback including dispersion:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SC</span><span class="o">.</span><span class="n">INJ</span><span class="o">.</span><span class="n">trackMode</span> <span class="o">=</span> <span class="s1">&#39;ORB&#39;</span>
<span class="n">MCO</span> <span class="o">=</span> <span class="n">SCgetModelRM</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="n">SC</span><span class="o">.</span><span class="n">ORD</span><span class="o">.</span><span class="n">BPM</span><span class="p">,</span> <span class="n">SC</span><span class="o">.</span><span class="n">ORD</span><span class="o">.</span><span class="n">CM</span><span class="p">,</span> <span class="n">trackMode</span><span class="o">=</span><span class="s1">&#39;ORB&#39;</span><span class="p">)</span>
<span class="n">eta</span> <span class="o">=</span> <span class="n">SCgetModelDispersion</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="n">SC</span><span class="o">.</span><span class="n">ORD</span><span class="o">.</span><span class="n">BPM</span><span class="p">,</span> <span class="n">SC</span><span class="o">.</span><span class="n">ORD</span><span class="o">.</span><span class="n">RF</span><span class="p">,</span>
                           <span class="n">trackMode</span><span class="o">=</span><span class="s1">&#39;ORB&#39;</span><span class="p">,</span> <span class="n">Z0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
                           <span class="n">nTurns</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rfStep</span><span class="o">=</span><span class="mf">1E3</span><span class="p">,</span>
                           <span class="n">useIdealRing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">SC</span> <span class="o">=</span> <span class="n">correct</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">MCO</span><span class="p">,</span> <span class="mf">1E8</span> <span class="o">*</span> <span class="n">eta</span><span class="p">)),</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxsteps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">scaleDisp</span><span class="o">=</span><span class="mf">1E8</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="pySC.correction.orbit_trajectory.first_turn">
<span class="sig-prename descclassname"><span class="pre">pySC.correction.orbit_trajectory.</span></span><span class="sig-name descname"><span class="pre">first_turn</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">SC</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">response_matrix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reference</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cm_ords</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bpm_ords</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">maxsteps</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">100</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">pinv_params</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/pySC/correction/orbit_trajectory.html#first_turn"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#pySC.correction.orbit_trajectory.first_turn" title="Permalink to this definition"></a></dt>
<dd><p>Achieves one-turn transmission</p>
<p>Achieves a first turn in <cite>SC.RING</cite>.  This algorithm is based on the idea that
repeated trajectory corrections calculated via a suitably regularized
pseudo-inverse  of <cite>response matrix</cite> will drive the BPM readings
and CM settings to a fixed point.</p>
<p>lim_{n-&gt;oo}  B_n = const. , with B_{n+1}  = Phi(response_matrix^{-1} . B_{n} ),     (1)</p>
<p>where mapping Phi maps corrector kicks to BPM-readings.
The RMS-values of both, BPM readings and CM settings, are determined by the
regularization of pseudo-inverted response matrix.  Successively - during the course of repeated
application of (1) - more and more transmission is achieved throughout the
ring, more magnets are traversed near their magnetic center (which is hopefully
at least somewhere near the BPM zero-point), resulting in decreased kicks.
Otherwise,if trajectory correction cannot proceed further to next BPM
the kicks of an increasing number of the last reached CMs are deterministically <a href="#id1"><span class="problematic" id="id2">``</span></a>wiggled’’
until transmission to the next BPM is achieved. Then, application of (1) is resumed.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>SC</strong> -- SimulatedCommissioning class instance.</p></li>
<li><p><strong>response_matrix</strong> -- Trajectory-response matrix.</p></li>
<li><p><strong>reference</strong> -- (None) target orbit in the format <cite>[x_1 … x_n y_1 …y_n]</cite>, where
[x_i,y_i]` is the target position at the i-th BPM.</p></li>
<li><p><strong>cm_ords</strong> -- List of CM ordinates to be used for correction (SC.ORD.CM)</p></li>
<li><p><strong>bpm_ords</strong> -- List of BPM ordinates at which the reading should be evaluated (SC.ORD.BPM)</p></li>
<li><p><strong>maxsteps</strong> -- break, if this number of correction steps have been performed (default = 100)</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>SimulatedCommissioning class instance with corrected <cite>SC.RING</cite></p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="pySC.correction.orbit_trajectory.stitch">
<span class="sig-prename descclassname"><span class="pre">pySC.correction.orbit_trajectory.</span></span><span class="sig-name descname"><span class="pre">stitch</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">SC</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">response_matrix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reference</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cm_ords</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bpm_ords</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_bpms</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">4</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">maxsteps</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">30</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">pinv_params</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/pySC/correction/orbit_trajectory.html#stitch"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#pySC.correction.orbit_trajectory.stitch" title="Permalink to this definition"></a></dt>
<dd><p>Achieves 2-turn transmission</p>
<p>The purpose of this function is to go from 1-turn transmission to 2-turn
transmission. This is done by applying orbit correction based on the pseudo
inverse trajectory response matrix ‘Mplus’ applied to the first BPMs in
the ‘SC.RING’. The reading of the BPMs in the second turn is corrected
towards the reading of these BPMs in the first turn. This approach has been
seen to be more stable than the direct application of the two-turn inverse
response matrix to the two-turn BPM data.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>SC</strong> -- SimulatedCommissioning class instance.</p></li>
<li><p><strong>response_matrix</strong> -- Trajectory-response matrix.</p></li>
<li><p><strong>reference</strong> -- (None) target orbit in the format <cite>[x_1 … x_n y_1 …y_n]</cite>, where
[x_i,y_i]` is the target position at the i-th BPM.</p></li>
<li><p><strong>cm_ords</strong> -- List of CM ordinates to be used for correction (SC.ORD.CM)</p></li>
<li><p><strong>bpm_ords</strong> -- List of BPM ordinates at which the reading should be evaluated (SC.ORD.BPM)</p></li>
<li><p><strong>n_bpms</strong> -- Number of BPMs to match the trajectory in first and second turn</p></li>
<li><p><strong>maxsteps</strong> -- break, if this number of correction steps have been performed (default = 100)</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>SimulatedCommissioning class instance with corrected <cite>SC.RING</cite></p>
</dd>
</dl>
<p class="rubric">Examples</p>
<p>Calculate the 2-turn response matrix and get the pseudo inverse using a Tikhonov regularization
parameter of 10. Switch the injection pattern to 2 turns and apply the stitching using the first
three BPMs, for a maximum of 20 steps:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RM2</span> <span class="o">=</span> <span class="n">SCgetModelRM</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="n">SC</span><span class="o">.</span><span class="n">ORD</span><span class="o">.</span><span class="n">BPM</span><span class="p">,</span> <span class="n">SC</span><span class="o">.</span><span class="n">ORD</span><span class="o">.</span><span class="n">CM</span><span class="p">,</span> <span class="n">nTurns</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">SC</span><span class="o">.</span><span class="n">INJ</span><span class="o">.</span><span class="n">nTurns</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">SC</span> <span class="o">=</span> <span class="n">stitch</span><span class="p">(</span><span class="n">SC</span><span class="p">,</span> <span class="n">RM2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">nBPMs</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxsteps</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="module-pySC.correction.rf"></span><section id="rf">
<h2>RF<a class="headerlink" href="#rf" title="Permalink to this heading"></a></h2>
<p>This module contains functions to correct RF phase and frequency.</p>
</section>
<dl class="py function">
<dt class="sig sig-object py" id="pySC.correction.rf.phase_and_energy_error">
<span class="sig-prename descclassname"><span class="pre">pySC.correction.rf.</span></span><span class="sig-name descname"><span class="pre">phase_and_energy_error</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">SC</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cav_ords</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/pySC/correction/rf.html#phase_and_energy_error"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#pySC.correction.rf.phase_and_energy_error" title="Permalink to this definition"></a></dt>
<dd><p>This is not a simple observable in reality.</p>
</dd></dl>

<span class="target" id="module-pySC.correction.tune"></span><section id="tune">
<h2>Tune<a class="headerlink" href="#tune" title="Permalink to this heading"></a></h2>
<p>This module contains functions to correct betatron tunes.</p>
</section>
<dl class="py function">
<dt class="sig sig-object py" id="pySC.correction.tune.tune_scan">
<span class="sig-prename descclassname"><span class="pre">pySC.correction.tune.</span></span><span class="sig-name descname"><span class="pre">tune_scan</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">SC</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">quad_ords</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">rel_quad_changes</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">n_points</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">60</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">do_plot</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nParticles</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nTurns</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">full_scan</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/pySC/correction/tune.html#tune_scan"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#pySC.correction.tune.tune_scan" title="Permalink to this definition"></a></dt>
<dd><p>Varies two quadrupole families to improve beam transmission, on a grid of relative setpoints specified in
<cite>rel_quad_changes</cite> in a spiral-like pattern to increase the beam transmission.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>SC</strong> -- SimulatedCommissioning instance</p></li>
<li><p><strong>quad_ords</strong> -- [1x2] array of quadrupole ordinates {<cite>[1 x NQ1],[1 x NQ2]</cite>}</p></li>
<li><p><strong>rel_quad_changes</strong> -- [1x2] cell array of quadrupole setpoints {<cite>[SP1_1,…,SP1_N1],[SP2_1,…,SP2_N2]</cite>} with <cite>N2=N1</cite></p></li>
<li><p><strong>target</strong> (<em>int</em><em>, </em><em>optional</em>) -- Transmission target at <cite>nTurns</cite></p></li>
<li><p><strong>n_points</strong> (<em>int</em><em>, </em><em>optional</em>) -- Number of points for the scan</p></li>
<li><p><strong>nParticles</strong> (<em>int</em><em>, </em><em>optional</em>) -- Number of particles used for tracking (for convenience, otherwise <cite>SC.INJ.nParticles</cite> is used)</p></li>
<li><p><strong>nTurns</strong> (<em>int</em><em>, </em><em>optional</em>) -- Number of turns used for tracking (for convenience, otherwise <cite>SC.INJ.nTurns</cite> is used)</p></li>
<li><p><strong>full_scan</strong> (<em>bool</em><em> , </em><em>optional</em>) -- If false, the scan finishes as soon as the target is reached</p></li>
<li><p><strong>do_plot</strong> (<em>bool</em><em> , </em><em>optional</em>) -- If true, beam transmission is plotted at every step</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>Updated SC structure with applied setpoints for maximised beam transmission
Relative setpoints which satisfied the target condition if reached, or the values which resulted in best transmission
Number of achieved turns
Turn-by-turn particle loss</p>
</dd>
</dl>
<p>see also: <em>bpm_reading</em>, <em>generate_bunches</em></p>
</dd></dl>

<span class="target" id="module-pySC.correction.chroma"></span><section id="chromaticity">
<h2>Chromaticity<a class="headerlink" href="#chromaticity" title="Permalink to this heading"></a></h2>
<p>This module contains functions to fit the chromaticity of ‘SC.RING’.</p>
</section>
<dl class="py function">
<dt class="sig sig-object py" id="pySC.correction.chroma.fit_chroma">
<span class="sig-prename descclassname"><span class="pre">pySC.correction.chroma.</span></span><span class="sig-name descname"><span class="pre">fit_chroma</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">SC</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">s_ords</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">target_chroma</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">init_step_size</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">array([2,</span> <span class="pre">2])</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">xtol</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.0001</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ftol</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.001</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/pySC/correction/chroma.html#fit_chroma"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#pySC.correction.chroma.fit_chroma" title="Permalink to this definition"></a></dt>
<dd><p>Applies a chromaticity correction using two sextupole families.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>SC</strong> -- SimulatedCommissioning instance</p></li>
<li><p><strong>s_ords</strong> -- [2xN] array or list [[1 x NS1],[1 x NS2], [1 x NS3], …] of sextupole ordinates</p></li>
<li><p><strong>target_chroma</strong> (<em>[</em><em>1x2</em><em>] </em><em>array</em><em>, </em><em>optional</em>) -- Target chromaticity for correction. Default: chromaticity of ‘SC.IDEALRING’</p></li>
<li><p><strong>init_step_size</strong> (<em>[</em><em>1x2</em><em>] </em><em>array</em><em>, </em><em>optional</em>) -- Initial step size for the solver. Default: [2,2]</p></li>
<li><p><strong>xtol</strong> (<em>float</em><em>, </em><em>optional</em>) -- Step tolerance for solver. Default: 1e-4</p></li>
<li><p><strong>ftol</strong> (<em>float</em><em>, </em><em>optional</em>) -- Merit tolerance for solver. Default: 1e-3</p></li>
</ul>
</dd>
<dt class="field-even">Returns<span class="colon">:</span></dt>
<dd class="field-even"><p>SimulatedCommissioning instance with corrected chromaticity.</p>
</dd>
<dt class="field-odd">Return type<span class="colon">:</span></dt>
<dd class="field-odd"><p>SC</p>
</dd>
</dl>
<p class="rubric">Example</p>
<p>SC = fit_chroma(SC, s_ords=[SCgetOrds(sc.RING, ‘SF’), SCgetOrds(sc.RING, ‘SD’)], target_chroma=numpy.array([1,1]))</p>
</dd></dl>

</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="core_structure.html" class="btn btn-neutral float-left" title="Core structure" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="lattice_properties.html" class="btn btn-neutral float-right" title="Lattice properties" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>